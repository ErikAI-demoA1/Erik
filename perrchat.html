<!DOCTYPE html>
<html lang="sk">
<head>
  <meta charset="UTF-8">
  <title>ErikAI Peer Chat - Spojenie kódom</title>
  <style>
    body { font-family: sans-serif; padding: 1rem; background: #f4f4f4; }
    textarea, input[type=text] { width: 100%; margin-bottom: 10px; padding: 10px; }
    button { width: 100%; padding: 10px; background: #007bff; color: white; border: none; margin-bottom: 10px; }
    .log { height: 150px; background: #fff; overflow-y: auto; border: 1px solid #ccc; padding: 0.5rem; }
    .status { font-weight: bold; color: green; margin-bottom: 10px; }
  </style>
</head>
<body>
  <h2>💬 ErikAI Peer Chat (cez kód)</h2>

  <button onclick="vytvorKod()">🔐 Vytvor kód (mobil 1)</button>
  <textarea id="vygenerovanyKod" placeholder="Tu sa zobrazí tvoj kód..."></textarea>

  <input type="text" id="prijatyKod" placeholder="Sem vlož kód od kamoša...">
  <button onclick="pripojKod()">🔓 Pripoj sa (mobil 2)</button>

  <div class="status" id="stavSpojenia">❌ Zatiaľ nie ste spojení</div>

  <input type="text" id="sprava" placeholder="Napíš správu...">
  <button onclick="odosliSpravu()">✉️ Poslať</button>
  <div class="log" id="chat"></div>

  <script>
    let pc;
    let dc;
    let spojene = false;

    const konfiguracia = {
      iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
    };

    async function vytvorKod() {
      pc = new RTCPeerConnection(konfiguracia);
      dc = pc.createDataChannel("chat");
      nastavChat();

      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      document.getElementById("vygenerovanyKod").value = btoa(JSON.stringify(offer));
    }

    async function pripojKod() {
      const kod = document.getElementById("prijatyKod").value;
      const offer = JSON.parse(atob(kod));
      pc = new RTCPeerConnection(konfiguracia);

      pc.ondatachannel = (e) => {
        dc = e.channel;
        nastavChat();
      };

      await pc.setRemoteDescription(offer);
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      const kodAnswer = btoa(JSON.stringify(answer));
      prompt("Pošli tento kód naspäť prvému mobilu:", kodAnswer);
    }

    function nastavChat() {
      dc.onopen = () => {
        spojene = true;
        document.getElementById("stavSpojenia").textContent = "✅ Ste spojení, môžete písať!";
        document.getElementById("stavSpojenia").style.color = "green";
      };
      dc.onmessage = (e) => {
        document.getElementById("chat").innerHTML += `<div><b>🟢 Kamoš:</b> ${e.data}</div>`;
      };
    }

    function odosliSpravu() {
      const text = document.getElementById("sprava").value;
      if (!spojene) {
        alert("Najprv sa musíte spojiť cez kód!");
        return;
      }
      dc.send(text);
      document.getElementById("chat").innerHTML += `<div><b>🔵 Ty:</b> ${text}</div>`;
      document.getElementById("sprava").value = "";
    }
  </script>
</body>
</html>
